name: QPFL Autoscorer

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      week:
        description: 'NFL Week number'
        required: false
        type: number
      full_export:
        description: 'Run full export (includes historical data)'
        required: false
        type: boolean
        default: false
  
  # Trigger when lineups, trades, or transactions are updated (via API)
  push:
    paths:
      - 'data/lineups/**'
      - 'data/pending_trades.json'
      - 'data/transaction_log.json'
  
  # Scheduled runs - 30 minutes after nflverse data updates
  schedule:
    # Daily at 9:30 UTC / 5:30 AM ET
    - cron: '30 9 * 1,2,9-12 *'
    # TNF: 6:00 AM UTC Friday
    - cron: '0 6 * 1,2,9-12 5'
    # Sunday early: 10:30 PM UTC
    - cron: '30 22 * 1,2,9-12 0'
    # Sunday late: 0:35 UTC Monday
    - cron: '35 0 * 1,2,9-12 1'
    # SNF/MNF: 6:00 AM UTC Mon/Tue
    - cron: '0 6 * 1,2,9-12 1'
    - cron: '0 6 * 1,2,9-12 2'

env:
  PYTHON_VERSION: '3.11'
  CURRENT_SEASON: '2025'
  # Set to 'true' to only send emails to GSA (for testing)
  DISABLE_EMAILS: 'false'

concurrency:
  group: qpfl-scoring-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # Combined notification job - runs on push events only
  notify:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Detect and send notifications
        env:
          DISABLE_EMAILS: ${{ env.DISABLE_EMAILS }}
          GSA_EMAIL: ${{ secrets.GSA_EMAIL }}
          CGK_EMAIL: ${{ secrets.CGK_EMAIL }}
          CWR_EMAIL: ${{ secrets.CWR_EMAIL }}
          AYP_EMAIL: ${{ secrets.AYP_EMAIL }}
          JRW_EMAIL: ${{ secrets.JRW_EMAIL }}
          AST_EMAIL: ${{ secrets.AST_EMAIL }}
          WJK_EMAIL: ${{ secrets.WJK_EMAIL }}
          SLS_EMAIL: ${{ secrets.SLS_EMAIL }}
          RPA_EMAIL: ${{ secrets.RPA_EMAIL }}
          S_T_EMAIL: ${{ secrets.S_T_EMAIL }}
          J_J_EMAIL: ${{ secrets.J_J_EMAIL }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        run: |
          python3 << 'EOF'
          import json
          import os
          import re
          import smtplib
          from datetime import datetime, timedelta, timezone
          from email.mime.text import MIMEText
          
          def get_eastern_time():
              """Get current time formatted in Eastern Time."""
              utc_now = datetime.now(timezone.utc)
              year = utc_now.year
              # DST: 2nd Sunday March to 1st Sunday November
              march_1 = datetime(year, 3, 1, tzinfo=timezone.utc)
              dst_start = march_1 + timedelta(days=(6 - march_1.weekday()) % 7 + 7, hours=2)
              nov_1 = datetime(year, 11, 1, tzinfo=timezone.utc)
              dst_end = nov_1 + timedelta(days=(6 - nov_1.weekday()) % 7, hours=2)
              offset = timedelta(hours=-4) if dst_start <= utc_now < dst_end else timedelta(hours=-5)
              et = utc_now + offset
              return et.strftime("%b %d, %Y at %I:%M %p ET")
          
          TEAM_NAMES = {
              "GSA": "Griff", "CGK": "Kaminska", "CWR": "Reardon", "AYP": "Arnav",
              "JRW": "Joe W.", "WJK": "Bill", "SLS": "Stephen", "RPA": "Ryan",
              "S/T": "Spencer/Tim", "J/J": "Joe/Joe", "AST": "Anagh"
          }
          
          TEAM_EMAIL_VARS = {
              "GSA": "GSA_EMAIL", "CGK": "CGK_EMAIL", "CWR": "CWR_EMAIL", "AYP": "AYP_EMAIL",
              "JRW": "JRW_EMAIL", "AST": "AST_EMAIL", "WJK": "WJK_EMAIL", "SLS": "SLS_EMAIL",
              "RPA": "RPA_EMAIL", "S/T": "S_T_EMAIL", "J/J": "J_J_EMAIL"
          }
          
          disable_emails = os.environ.get('DISABLE_EMAILS', 'false').lower() == 'true'
          
          def get_recipients(team_codes=None):
              """Get email recipients. If team_codes provided, only those teams."""
              if disable_emails:
                  emails = os.environ.get('GSA_EMAIL', '')
                  return [e.strip() for e in emails.split(',') if e.strip()]
              
              recipients = []
              vars_to_check = [TEAM_EMAIL_VARS[t] for t in team_codes] if team_codes else TEAM_EMAIL_VARS.values()
              for var in vars_to_check:
                  emails = os.environ.get(var, '')
                  recipients.extend([e.strip() for e in emails.split(',') if e.strip()])
              return list(set(recipients))
          
          def send_email(subject, body, recipients):
              """Send email via SMTP."""
              if not recipients:
                  print(f"No recipients for: {subject}")
                  return
              
              smtp_user = os.environ.get('SMTP_USERNAME')
              smtp_pass = os.environ.get('SMTP_PASSWORD')
              if not smtp_user or not smtp_pass:
                  print(f"SMTP not configured, would send: {subject}")
                  return
              
              msg = MIMEText(body)
              msg['Subject'] = subject
              msg['From'] = f"QPFL Bot <{smtp_user}>"
              msg['To'] = ', '.join(recipients)
              
              try:
                  with smtplib.SMTP('smtp.gmail.com', 587) as server:
                      server.starttls()
                      server.login(smtp_user, smtp_pass)
                      server.sendmail(smtp_user, recipients, msg.as_string())
                  print(f"Sent: {subject} to {len(recipients)} recipients")
              except Exception as e:
                  print(f"Email error: {e}")
          
          def format_player(player):
              if isinstance(player, dict):
                  name = player.get('name', 'Unknown')
                  pos = player.get('position', '')
                  team = player.get('nfl_team', '')
                  if pos and team:
                      return f"{pos} {name} ({team})"
                  return name
              return player
          
          # Get changed files
          changed = os.popen("git diff --name-only HEAD~1 HEAD").read().strip().split('\n')
          
          # --- LINEUP NOTIFICATIONS ---
          lineup_changes = [f for f in changed if f.startswith('data/lineups/') and f.endswith('.json')]
          if lineup_changes:
              week_num = None
              body = f"QPFL Lineup Update\n{get_eastern_time()}\n\n"
              
              for filepath in lineup_changes:
                  if not os.path.exists(filepath):
                      continue
                  
                  match = re.search(r'week_(\d+)', filepath)
                  if match:
                      week_num = match.group(1)
                  
                  with open(filepath) as f:
                      data = json.load(f)
                  
                  prev_data = {}
                  try:
                      prev = os.popen(f"git show HEAD~1:{filepath} 2>/dev/null").read()
                      if prev:
                          prev_data = json.loads(prev)
                          except:
                      pass

                  for team_code, lineup in data.get('lineups', {}).items():
                      prev_lineup = prev_data.get('lineups', {}).get(team_code, {})
                      if lineup != prev_lineup:
                      owner = TEAM_NAMES.get(team_code, team_code)
                          body += f"------------------------------\n"
                          body += f"Week {week_num} - {owner} ({team_code})\n"
                          body += f"------------------------------\n"
                          
                      for pos, players in lineup.items():
                          if pos in ('comment', 'submitted_at', 'starters'):
                              continue
                          if isinstance(players, list):
                                  for p in players:
                                      body += f"  {pos}: {p}\n"
                          body += "\n"
              
              body += "View lineups: https://qpfl.github.io/scoring/\n"
              send_email(f"QPFL Lineups - Week {week_num}", body, get_recipients())
          
          # --- TRADE NOTIFICATIONS ---
          if 'data/pending_trades.json' in changed:
          with open('data/pending_trades.json') as f:
              data = json.load(f)
          
          prev_trades = []
          try:
                  prev = os.popen("git show HEAD~1:data/pending_trades.json 2>/dev/null").read()
                  if prev:
                      prev_trades = json.loads(prev).get('trades', [])
          except:
              pass
          
              prev_ids = {t.get('id', str(i)) for i, t in enumerate(prev_trades)}
              new_trades = [t for i, t in enumerate(data.get('trades', [])) if t.get('id', str(i)) not in prev_ids]
              
              for trade in new_trades:
                  # API uses: proposer, partner, proposer_gives, proposer_receives
                  proposer = trade.get('proposer', 'Unknown')
                  partner = trade.get('partner', 'Unknown')
                  proposer_gives = trade.get('proposer_gives', {})
                  proposer_receives = trade.get('proposer_receives', {})
              status = trade.get('status', '').lower()
              
                  body = ""
              if status in ('completed', 'accepted'):
                      body += f"==============================\nTRADE COMPLETED\n{get_eastern_time()}\n==============================\n\n"
                      recipients = get_recipients()
              else:
                      body += f"==============================\nTRADE PROPOSAL\n{get_eastern_time()}\n==============================\n\n"
                      recipients = get_recipients([proposer, partner])
                  
                  body += f"{TEAM_NAMES.get(proposer, proposer)} ({proposer}) sends:\n"
                  for p in proposer_gives.get('players', []):
                      body += f"  - {format_player(p) if isinstance(p, dict) else p}\n"
                  for pick in proposer_gives.get('picks', []):
                      body += f"  - {pick}\n"
                  
                  body += f"\n{TEAM_NAMES.get(partner, partner)} ({partner}) sends:\n"
                  for p in proposer_receives.get('players', []):
                      body += f"  - {format_player(p) if isinstance(p, dict) else p}\n"
                  for pick in proposer_receives.get('picks', []):
                      body += f"  - {pick}\n"
                  
                  body += "\nView: https://qpfl.github.io/scoring/#transactions\n"
                  
                  subject = "QPFL Trade Completed" if status in ('completed', 'accepted') else f"QPFL Trade Proposal from {TEAM_NAMES.get(proposer, proposer)}"
                  send_email(subject, body, recipients)
          
          # --- TRANSACTION NOTIFICATIONS ---
          if 'data/transaction_log.json' in changed:
          with open('data/transaction_log.json') as f:
              data = json.load(f)
          
              prev_txns = []
              try:
                  prev = os.popen("git show HEAD~1:data/transaction_log.json 2>/dev/null").read()
                  if prev:
                      prev_txns = json.loads(prev).get('transactions', [])
          except:
              pass
          
              new_txns = data.get('transactions', [])[len(prev_txns):]
              
              if new_txns:
                  body = f"QPFL Roster Transaction\n{get_eastern_time()}\n\n"
                  week = None
                  
                  for txn in new_txns:
              team_code = txn.get('team', 'Unknown')
              team_name = TEAM_NAMES.get(team_code, team_code)
                      txn_type = txn.get('type', 'transaction').replace('_', ' ').title()
              added = txn.get('added') or txn.get('activated', '')
              released = txn.get('released', '')
                      week = txn.get('week', week)
                      
                      body += f"------------------------------\n"
                      body += f"{txn_type} - {team_name} ({team_code})\n"
                      body += f"------------------------------\n"
              if added:
                          body += f"  + ADDED: {format_player(added)}\n"
              if released:
                          body += f"  - RELEASED: {format_player(released)}\n"
                      body += "\n"
                  
                  body += "View: https://qpfl.github.io/scoring/#transactions\n"
                  send_email(f"QPFL Roster Move - Week {week}", body, get_recipients())
          
          print("Notification processing complete")
          EOF

  # Scoring job - runs on schedule, push, or manual
  # Skips scoring for trade-only changes (propose/respond)
  score:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Check if scoring needed
        id: check
        run: |
          # Skip scoring for trade-only changes (proposals, responses)
          if [ "${{ github.event_name }}" = "push" ]; then
            CHANGED=$(git diff --name-only HEAD~1 HEAD)
            echo "Changed files: $CHANGED"
            
            # If only pending_trades.json changed, skip scoring
            if echo "$CHANGED" | grep -qE '^data/pending_trades\.json$' && ! echo "$CHANGED" | grep -qvE '^data/pending_trades\.json$'; then
              echo "Only pending_trades.json changed - skipping scoring"
              echo "skip=true" >> $GITHUB_OUTPUT
            else
              echo "skip=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Set up Python
        if: steps.check.outputs.skip != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        if: steps.check.outputs.skip != 'true'
        run: |
          python -m pip install --upgrade pip
          # Core deps only - no python-docx needed
          pip install nflreadpy polars openpyxl pandas
      
      - name: Determine current NFL week
        if: steps.check.outputs.skip != 'true'
        id: week
        run: |
          WEEK="${{ github.event.inputs.week }}"
          if [ -z "$WEEK" ]; then
            WEEK=$(python -c "
          import nflreadpy as nfl
          print(min(nfl.get_current_week(), 17))
          ")
          fi
          echo "week=$WEEK" >> $GITHUB_OUTPUT
          echo "Scoring NFL Week: $WEEK"
      
      # === 2025 SEASON (Excel-based) ===
      - name: Sync JSON lineups to Excel (2025 only)
        if: steps.check.outputs.skip != 'true' && env.CURRENT_SEASON == '2025'
        run: python scripts/sync_lineups_to_excel.py ${{ steps.week.outputs.week }}
      
      - name: Run autoscorer (Excel-based for 2025)
        if: steps.check.outputs.skip != 'true' && env.CURRENT_SEASON == '2025'
        run: python autoscorer.py --week ${{ steps.week.outputs.week }} --sheet "Week ${{ steps.week.outputs.week }}" --update
      
      # === 2026+ SEASON (JSON-based) ===
      - name: Run autoscorer (JSON-based for 2026+)
        if: steps.check.outputs.skip != 'true' && env.CURRENT_SEASON != '2025'
        run: python autoscorer_json.py --season ${{ env.CURRENT_SEASON }} --week ${{ steps.week.outputs.week }} --update-standings
      
      - name: Sync roster changes to Excel (2026+ backup)
        if: steps.check.outputs.skip != 'true' && env.CURRENT_SEASON != '2025'
        run: python scripts/sync_rosters_to_excel.py
      
      - name: Export scores for web
        if: steps.check.outputs.skip != 'true'
        run: |
          if [ "${{ github.event.inputs.full_export }}" == "true" ]; then
            echo "Running full export..."
          python scripts/export_for_web.py
            python scripts/export_hall_of_fame.py
          else
            echo "Running current season export..."
            python scripts/export_current.py --season ${{ env.CURRENT_SEASON }}
          fi
      
      - name: Commit and push
        if: steps.check.outputs.skip != 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add all data files (no more Excel score files)
          git add web/data.json web/data/ data/
          # Also add Rosters.xlsx if it exists (for roster backup)
          [ -f Rosters.xlsx ] && git add Rosters.xlsx || true
          
          git diff --staged --quiet || git commit -m "Update scores for Week ${{ steps.week.outputs.week }} - $(date -u '+%Y-%m-%d %H:%M UTC')"
          
          # Retry with backoff
          for i in 1 2 3 4 5; do
            git pull --rebase origin main
            if git push; then break; fi
            echo "Retry $i..."
            sleep $((2**i))
          done
      
      - name: Setup Pages
        if: steps.check.outputs.skip != 'true'
        uses: actions/configure-pages@v4
      
      - name: Upload Pages artifact
        if: steps.check.outputs.skip != 'true'
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./web
      
      - name: Deploy to GitHub Pages
        if: steps.check.outputs.skip != 'true'
        uses: actions/deploy-pages@v4
